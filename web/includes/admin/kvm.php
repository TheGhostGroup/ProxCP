<?php

if (count(get_included_files()) == 1) {
    exit("You just broke everything.");
}
require_once "menu_main.php";
echo "<div class=\"row\">\r\n    <div class=\"col-md-12\">\r\n        <div class=\"panel panel-default\">\r\n            <div class=\"panel-body\">\r\n              <div class=\"clearfix\"><a class=\"btn btn-info btn-sm pull-right\" href=\"https://docs.proxcp.com/index.php?title=ProxCP_Admin_-_KVM\" role=\"button\" target=\"_blank\"><i class=\"fa fa-book\"></i> Related Documentation</a></div>\r\n                <h2 align=\"center\">Manage KVM</h2><br />\r\n                ";
if ($kvmCreatedSuccess) {
    if (!$cipassword) {
        echo "<div id=\"adm_message\"><div class=\"alert alert-success\" role=\"alert\"><strong>Success:</strong> KVM created successfully!</div></div>";
    } else {
        echo "<div id=\"adm_message\"><div class=\"alert alert-success\" role=\"alert\"><strong>Success:</strong> KVM created successfully!<br />Password: " . $cipassword . "</div></div>";
    }
} else {
    echo "<div id=\"adm_message\"></div>";
}
echo "                <div class=\"table-responsive\">\r\n                    <table class=\"table table-hover\" id=\"admin_kvmtable\">\r\n                        <thead>\r\n                            <tr>\r\n                                <th>User ID</th>\r\n                                <th>Billing ID</th>\r\n                                <th>Node</th>\r\n                                <th>OS</th>\r\n                                <th>IP</th>\r\n                                <th>Suspend</th>\r\n                                <th>Delete</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            ";
$admin_datakvm = $db->get("vncp_kvm_ct", ["user_id", "!=", 0]);
$admin_kvm = $admin_datakvm->all();
for ($k = 0; $k < count($admin_kvm); $k++) {
    echo "<tr>";
    echo "<td>" . $admin_kvm[$k]->user_id . "</td>";
    echo "<td>" . $admin_kvm[$k]->hb_account_id . "</td>";
    echo "<td>" . $admin_kvm[$k]->node . "</td>";
    echo "<td>" . $admin_kvm[$k]->os . "</td>";
    echo "<td>" . $admin_kvm[$k]->ip . "</td>";
    if ($admin_kvm[$k]->suspended == 0) {
        echo "<td><button class=\"btn btn-danger btn-sm\" id=\"kvmsuspend" . $admin_kvm[$k]->hb_account_id . "\" role=\"" . $admin_kvm[$k]->hb_account_id . "\">Suspend</button></td>";
    } else {
        echo "<td><button class=\"btn btn-success btn-sm\" id=\"kvmunsuspend" . $admin_kvm[$k]->hb_account_id . "\" role=\"" . $admin_kvm[$k]->hb_account_id . "\">Unsuspend</button></td>";
    }
    echo "<td><button id=\"admin_kvmdelete" . $admin_kvm[$k]->hb_account_id . "\" class=\"btn btn-sm btn-danger\" role=\"" . $admin_kvm[$k]->hb_account_id . "\">Delete</button></td>";
    echo "</tr>";
}
echo "                        </tbody>\r\n                    </table>\r\n                </div>\r\n                <h2 align=\"center\">Create KVM</h2>\r\n                <form role=\"form\" action=\"\" method=\"POST\" id=\"adm_createkvm_form\">\r\n                    <div class=\"form-group\">\r\n                        <label>User ID</label><br />\r\n                        <select class=\"form-control selectpicker\" data-live-search=\"true\" name=\"userid\">\r\n                          <option value=\"default\">Select...</option>\r\n                          ";
$userdata = $db->get("vncp_users", ["id", "!=", 0])->all();
for ($i = 0; $i < count($userdata); $i++) {
    echo "<option value=\"" . $userdata[$i]->id . "\">" . $userdata[$i]->email . " (ID: " . $userdata[$i]->id . ")</option>";
}
echo "                        </select>\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label>Billing Account ID</label>\r\n                        <input class=\"form-control\" type=\"text\" name=\"hb_account_id\" placeholder=\"100\" />\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label>Pool ID</label>\r\n                        <input class=\"form-control\" type=\"text\" name=\"poolid\" placeholder=\"client_id_1\" />\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label>Node</label>\r\n                        <select class=\"form-control\" name=\"node\" id=\"node\">\r\n                        \t<option value=\"default\">Select...</option>\r\n                        \t";
$kvm_node = $db->get("vncp_nodes", ["id", "!=", 0]);
$kvm_node = $kvm_node->all();
for ($k = 0; $k < count($kvm_node); $k++) {
    $isNATNode = $db->get("vncp_nat", ["node", "=", $kvm_node[$k]->name])->all();
    if (count($isNATNode) == 1) {
        echo "<option value=\"" . $kvm_node[$k]->name . "\">" . $kvm_node[$k]->hostname . " (NAT: " . $isNATNode[0]->natcidr . ")</option>";
    } else {
        echo "<option value=\"" . $kvm_node[$k]->name . "\">" . $kvm_node[$k]->hostname . "</option>";
    }
}
echo "                        </select>\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label>KVM Hostname</label>\r\n                        <input class=\"form-control\" type=\"text\" name=\"hostname\" placeholder=\"server.name\" />\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label>KVM NAT Enabled?</label>\r\n                        <select class=\"form-control\" name=\"kvmisnat\" id=\"kvmisnat\">\r\n                          <option value=\"default\">Select...</option>\r\n                          <option value=\"false\">False</option>\r\n                          <option value=\"true\">True</option>\r\n                        </select>\r\n                    </div>\r\n                    <div id=\"kvmnatfields\" style=\"display:none;\"><div class=\"form-group\">\r\n                        <label>NAT Public Ports <small>how many public ports should this KVM get?</small></label>\r\n                        <input class=\"form-control\" type=\"number\" name=\"natpublicports\" placeholder=\"20\" />\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label>NAT Domain Forwarding <small>how many proxied domains should this KVM get?</small></label>\r\n                        <input class=\"form-control\" type=\"number\" name=\"natdomainproxy\" placeholder=\"5\" />\r\n                    </div></div>\r\n                    <div class=\"form-group\">\r\n                        <label>Operating System Installation Type</label>\r\n                        <select class=\"form-control\" name=\"os_installation_type\" id=\"os_installation_type\">\r\n                            <option value=\"default\">Select...</option>\r\n                            <option value=\"iso\">ISO (manual installation)</option>\r\n                            <option value=\"template\">Template (automatic installation)</option>\r\n                        </select>\r\n                    </div>\r\n                    <div id=\"admin_createkvm_template\" style=\"display:none;\"><div class=\"form-group\">\r\n                        <label>Operating System</label>\r\n                        <select class=\"form-control\" name=\"ostemplate\">\r\n                        \t<option value=\"default\">Select...</option>\r\n                        \t";
$kvm_templates = $db->get("vncp_kvm_templates", ["id", "!=", 0]);
$kvm_templates = $kvm_templates->all();
for ($k = 0; $k < count($kvm_templates); $k++) {
    echo "<option value=\"" . $kvm_templates[$k]->id . "\">" . $kvm_templates[$k]->friendly_name . " (Node: " . $kvm_templates[$k]->node . ")</option>";
}
echo "                        </select>\r\n                    </div></div>\r\n                    <div id=\"admin_createkvm_iso\" style=\"display:none;\"><div class=\"form-group\">\r\n                        <label>Operating System</label>\r\n                        <select class=\"form-control\" name=\"osfriendly\">\r\n                        \t<option value=\"default\">Select...</option>\r\n                        \t";
$kvm_templates = $db->get("vncp_kvm_isos", ["id", "!=", 0]);
$kvm_templates = $kvm_templates->all();
for ($k = 0; $k < count($kvm_templates); $k++) {
    echo "<option value=\"" . $kvm_templates[$k]->volid . "\">" . $kvm_templates[$k]->friendly_name . "</option>";
}
echo "                        </select>\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label>Operating System Type <small>determines KVM optimizations/features</small></label>\r\n                        <select class=\"form-control\" name=\"ostype\">\r\n                            <option value=\"default\">Select...</option>\r\n                            <option value=\"other\">Other</option>\r\n                            <option value=\"wxp\">Windows XP</option>\r\n                            <option value=\"w2k\">Windows 2000</option>\r\n                            <option value=\"w2k3\">Windows 2003</option>\r\n                            <option value=\"w2k8\">Windows 2008</option>\r\n                            <option value=\"wvista\">Windows Vista</option>\r\n                            <option value=\"win7\">Windows 7</option>\r\n                            <option value=\"win8\">Windows 8/2012</option>\r\n                            <option value=\"win10\">Windows 10/2016</option>\r\n                            <option value=\"l24\">Linux 2.4 Kernel</option>\r\n                            <option value=\"l26\">Linux 2.6+ Kernel</option>\r\n                            <option value=\"solaris\">Solaris</option>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label>KVM NIC Driver</label>\r\n                        <select class=\"form-control\" name=\"nicdriver\">\r\n                            <option value=\"default\">Select...</option>\r\n                            <option value=\"e1000\">Intel E1000 (Windows)</option>\r\n                            <option value=\"virtio\">VirtIO (Linux)</option>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label>KVM Storage Driver</label>\r\n                        <select class=\"form-control\" name=\"storage_driver\">\r\n                            <option value=\"default\">Select...</option>\r\n                            <option value=\"ide\">IDE (Windows)</option>\r\n                            <option value=\"virtio\">VirtIO (Linux)</option>\r\n                        </select>\r\n                    </div></div>\r\n                    <div id=\"admin_createkvm_next\" style=\"display:none;\">\r\n                      <div class=\"form-group\">\r\n                          <label>IPv4</label>\r\n                          <input class=\"form-control\" type=\"text\" name=\"ipv4\" id=\"ipv4\" placeholder=\"1.1.1.5\" />\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>IPv4 Gateway</label>\r\n                          <input class=\"form-control\" type=\"text\" name=\"ipv4_gateway\" placeholder=\"1.1.1.1\" />\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>IPv4 Netmask</label>\r\n                          <input class=\"form-control\" type=\"text\" name=\"ipv4_netmask\" value=\"255.255.255.0\" />\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>KVM CPU Cores</label>\r\n                          <input class=\"form-control\" type=\"text\" name=\"cpucores\" placeholder=\"1\" />\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>KVM CPU Type</label>\r\n                          <select class=\"form-control\" name=\"cputype\">\r\n                              <option value=\"default\">Select...</option>\r\n                              <option value=\"host\">Host (passthrough)</option>\r\n                              <option value=\"kvm64\">kvm64</option>\r\n                              <option value=\"qemu64\">qemu64</option>\r\n                          </select>\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>KVM RAM (MB)</label>\r\n                          <input class=\"form-control\" type=\"text\" name=\"ram\" placeholder=\"512\" />\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>KVM Storage Location</label>\r\n                          <select class=\"form-control\" name=\"storage_location\" id=\"storage_location\">\r\n                          \t<option value=\"default\">Select...</option>\r\n                          </select>\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>KVM Storage Size (GB)</label>\r\n                          <input class=\"form-control\" type=\"text\" name=\"storage_size\" placeholder=\"20\" />\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>KVM Bandwidth Limit (GB)</label>\r\n                          <input class=\"form-control\" type=\"text\" name=\"bandwidth_limit\" placeholder=\"500\" />\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>Network Speed Limit (MB/s) <small>0 = unlimited, 1 MB/s = 0.125 Mb/s</small></label>\r\n                          <input class=\"form-control\" type=\"number\" name=\"portspeed\" value=\"0\" min=\"0\" max=\"10000\" />\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>MAC Address <small>optional, 00:00:00:00:00:00 format</small></label>\r\n                          <input class=\"form-control\" type=\"text\" name=\"setmacaddress\" placeholder=\"00:00:00:00:00:00\" />\r\n                      </div>\r\n                      <div class=\"form-group\">\r\n                          <label>VLAN Tag <small>optional</small></label>\r\n                          <input class=\"form-control\" type=\"number\" name=\"setvlantag\" placeholder=\"no VLAN\" max=\"4094\" min=\"0\" value=\"0\" />\r\n                      </div>\r\n                    </div>\r\n                    <input type=\"hidden\" name=\"token\" value=\"";
echo Token::generate();
echo "\" />\r\n                    <input type=\"submit\" value=\"Submit\" class=\"btn btn-success\" />\r\n                </form>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n";

?>
